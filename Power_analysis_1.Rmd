---
title: "Power Analysis"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
  mu_zeros2=replicate(15,0)
  sigma_control=avg_cov_control
  sigma_treatment=avg_cov_control

  sigma_treatment[2,1]=1.2*sigma_control[2,1]
  sigma_treatment[3,1]=1.2*sigma_control[3,1]
  sigma_treatment[3,2]=1.2*sigma_control[3,2]
  sigma_treatment[4,1]=1.2*sigma_control[4,1]
  sigma_treatment[4,2]=1.2*sigma_control[4,2]
  sigma_treatment[4,3]=1.2*sigma_control[4,3]

  sampled_control<-lapply(1:length(conventional_ids), mvrnorm, n=4800, mu=mu_zeros, Sigma=sigma_control)
  sampled_treatment<-lapply(1:length(short_ids), mvrnorm, n=4800, mu=mu_zeros, Sigma=sigma_treatment)


  X_for_short2<-sample_unseen(X_short_subj$PSQI_AmtSleep,short_ids)
  X_for_conv2<-sample_unseen(X_conv_subj$PSQI_AmtSleep,conventional_ids)
  X_for_short2<-cbind(inter = 1, X_for_short2)
  X_for_short2<-X_for_short2[,-3]
  X_for_conv2<-cbind(inter = 1, X_for_conv2)
  X_for_conv2<-X_for_conv2[,-3]
  Y_new_short2<-sampled_treatment
  Y_new_conventional2<-sampled_control
  
  fit_short2<-capReg(Y_new_short2,data.matrix(X_for_short2),method="CAP-C")
  fit_conv2<-capReg(Y_new_conventional2,data.matrix(X_for_conv2),method = "CAP-C")
  
  sample_cov_short_new2<-sample_covariance(Y_new_short2,channel_names,short_ids)
  sample_cov_conventional_new2<-sample_covariance(Y_new_conventional2,channel_names,conventional_ids)
  
  gg_inv_s_new2<-gamma_inv(fit_short2$gamma)
  gg_inv_c_new2<-gamma_inv(fit_conv2$gamma)
  
  t_for_short_new2<-sample_unseen(X_for_short2$X,short_ids)
  t_for_conv_new2<-sample_unseen(X_for_conv2$X,conventional_ids)
  
  cov_pred_short_new2 = cov_pred(fit_short2$gamma,fit_short2$beta,t_for_short_new2,gg_inv_s_new2)
  cov_pred_conv_new2 = cov_pred(fit_conv2$gamma,fit_conv2$beta,t_for_conv_new2,gg_inv_c_new2)
  
  ids=append(short_ids,conventional_ids)

  Y_t_new2=append(sample_cov_short_new2,cov_pred_conv_new2)
  names(Y_t_new2)<-ids

  Y_c_new2=append(cov_pred_short_new2,sample_cov_conventional_new2)
  names(Y_c_new2)<-ids
  
  
  Y_t_triangle_new2=list()
  for (j in 1:length(ids)){
    Y_t_triangle_new2[[j]]=get_triangle(Y_t_new2[[j]], triangle="LOWER")
  }

  Y_c_triangle_new2=list()
  for (k in 1:length(ids)){
    Y_c_triangle_new2[[k]]=get_triangle(Y_c_new2[[k]], triangle="LOWER")
  }

  names(Y_t_triangle_new2)<-ids
  names(Y_c_triangle_new2)<-ids
  
  paired_ttests_new2<-Repeated_ttest(channel_names,ids,triangle="LOWER",Y_t_triangle_new2,Y_c_triangle_new2)
  
  
  list_pvalues_new2=get_pvalues(paired_ttests_new2)
  list_pvalues_new2=as.double(list_pvalues_new2)
  
  pv_indexed_new2=tibble(pv=list_pvalues_new2, index=seq(1,105))
  pv_ind_ordered_new2=pv_indexed_new2%>%
  arrange(pv)
  count1_2=count(filter(pv_ind_ordered_new2, pv_ind_ordered_new2$pv<0.05))
  
  BH_pvalues_new2<-p.adjust(list_pvalues_new2, method = "BH")
  
  p_vs_BH_new2=tibble(list_pvalues_new2,BH_pvalues_new2, index=seq(1,105))
#p_vs_BH_new
  p_vs_BH_ord_new2=p_vs_BH_new2%>%
    arrange(list_pvalues_new2)
  
  pvsBH_reduced_new2=list(orig_p=numeric(), adj_p=numeric(), ind=numeric())
  j=1
  for (p in 1:length(p_vs_BH_ord_new2$list_pvalues_new2)){
    if (p_vs_BH_ord_new2$list_pvalues_new2[p]<p_vs_BH_ord_new2$BH_pvalues_new2[p]) {
      pvsBH_reduced_new2$orig_p[j]=p_vs_BH_ord_new2$list_pvalues_new2[p]
      pvsBH_reduced_new2$adj_p[j]=p_vs_BH_ord_new2$BH_pvalues_new2[p]
      pvsBH_reduced_new2$ind[j]=p_vs_BH_ord_new2$index[p]
      j=j+1
    }
  }

#pvsBH_reduced=tibble(original_p,adjusted_p, ind)
  pvsBH_reduced_new2=as_tibble(pvsBH_reduced_new2)

  acceptance_value_new2=as.numeric(max(pvsBH_reduced_new2$orig_p))

  acc_index_new2=pvsBH_reduced_new2$ind[pvsBH_reduced_new2$orig_p==acceptance_value_new2]
  #pvsBH_reduced
  #acceptance_value_new
  count2_2=count(filter(p_vs_BH_ord_new2, p_vs_BH_ord_new2$list_pvalues_new2<=acceptance_value_new2))
  #rejections[i]=count1
  
  #rejections_BH[i]=count2
  #acceptance[i]=acceptance_value_new
  #i=i+1 

```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
