---
title: "Internship: exploring causal inference in the context of brain connectivity "
output: html_notebook
author: Sophie Tascedda
date: "`r Sys.Date()`"
params:
  num_regions: "15"
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Loading libraries 
```{r}
library(CovRegFC)
library(cowplot)
library(ggplot2)
library(reshape2)
library(magrittr)
library(stringr)
library(devtools)
library(rstan)
library(abind)
library(BatchJobs)
library(reshape2)
library(rethinking)
library(cap)
library(dplyr)
params
```

## Loading HCP (Human Connectome Project) data
Analysis based on data from the WU-Minn HCP 1200 Subjects Data Release with four complete rfMRI runs (with 100% of collected time points).

Load subject info
```{r}
subject_info = read.csv("data/HCP_PTN820/sample_info.csv")
subject_info = subject_info[,c(
  "Subject",
  "Age",
  "Gender",
  "Acquisition",
  "PSQI_AmtSleep", # amount of sleep in hours
  "PSQI_Score" # Pittsburgh Sleep Quality Index (PSQI) Completed
  )] 
```

Define two groups: short and conventional sleepers according to the classification from Hirshkowitz et al. (2015)^[Hirshkowitz et al. (2015), National Sleep Foundation's sleep recommendations: Methodology and results summary, Sleep Health.]:

* short sleepers: average equal or less than 6 hours each night
* conventional sleepers: average between 7 and 9 hours each night

```{r}
sleep_duration = rep("undefined",nrow(subject_info))
sleep_duration[subject_info$PSQI_AmtSleep <= 6] = "short"
sleep_duration[(subject_info$PSQI_AmtSleep >= 7) & (subject_info$PSQI_AmtSleep <= 9)] = "conventional"
subject_info$sleep_duration = factor(sleep_duration)
table(subject_info$sleep_duration)
str(subject_info)
```
Load timeseries

```{r}
num_regions = as.integer(params$num_regions)
num_regions
channel_names = paste0("R",1:num_regions)
path = paste0("data/HCP_PTN820/node_timeseries/3T_HCP820_MSMAll_d",num_regions,"_ts2") 
file_names = list.files(path = path,pattern = ".txt")
file_subject_ids = strsplit(file_names,split = ".txt") %>% unlist
ts = lapply(file_subject_ids,function(Subject) {
  print(paste("reading subject:",Subject))
  full_path = paste0(path,"/",Subject,".txt")
  timeseries = read.csv(full_path,header = FALSE,sep = " ")
  timeseries$Subject = Subject
  timeseries
}) %>% do.call(rbind,.) %>% data.frame
names(ts)[1:num_regions] = channel_names
```
Merge timeseries and subject info, and separate in 2 groups. Here, "short" sleepers and "conventional" sleepers
```{r}
ts_subject_info = merge(ts,subject_info,by = "Subject")
ts_short = subset(ts_subject_info,sleep_duration=="short")
ts_short$timepoint = rep(1:(nrow(ts_short)/4),4)
ts_conventional = subset(ts_subject_info,sleep_duration=="conventional")
ts_conventional$timepoint = rep(1:(nrow(ts_conventional)/4),4)
```

## Generate our Y and X:
Y: timeseries data
X: covariate(s)

Short sleepers
```{r}
short_ids=unique(ts_short$Subject)
short_subj=subset(subject_info,sleep_duration=="short")
short_subj <- short_subj[short_subj$Subject %in% short_ids, ]
X_short_subj<-short_subj[order(short_subj$Subject),]
Y_short <- lapply(split(ts_short,ts_short$Subject), "[", TRUE, -c(17:24))
Y_short <- lapply(Y_short, "[", TRUE, -c(1))

```

Conventional sleepers
```{r}
conventional_ids=unique(ts_conventional$Subject)
conventional_subj=subset(subject_info,sleep_duration=="conventional")
conventional_subj <- conventional_subj[conventional_subj$Subject %in% conventional_ids, ]
X_conv_subj<-conventional_subj[order(conventional_subj$Subject),]
Y_conv <- lapply(split(ts_conventional,ts_conventional$Subject), "[", TRUE, -c(17:24))
Y_conv <- lapply(Y_conv, "[", TRUE, -c(1))
```


Select 1 covariate (here "PSQI_AmtSleep") and convert Y and X to matrices (required by capReg)
```{r}
X_short_subset<-subset(X_short_subj, select="PSQI_AmtSleep")
X_short_subset<-cbind(inter = 1, X_short_subset)

X_short_subset<-data.matrix(X_short_subset)
Y_short<-lapply(Y_short, function(x) data.matrix(x))
```

```{r}
X_conv_subset<-subset(X_conv_subj, select="PSQI_AmtSleep")
X_conv_subset<-cbind(inter = 1, X_conv_subset)

X_conv_subset<-data.matrix(X_conv_subset)
Y_conv<-lapply(Y_conv, function(x) data.matrix(x))
```
Center Y
```{r}
Y_c_short<- lapply(Y_short, function(x) scale(x,center = TRUE, scale = FALSE))
#Y_c_short<- lapply(Y_c_short, function(x) data.matrix(x))
Y_c_conv<- lapply(Y_conv, function(x) scale(x,center = TRUE, scale = FALSE))
#Y_c_conv<- lapply(Y_c_conv, function(x) data.matrix(x))
```
## Fit capReg

Fit of capReg, using CAP algorithm

```{r fitting cap}
fit_cap_short<-capReg(Y_c_short,X_short_subset,method="CAP")
fit_cap_conv<-capReg(Y_c_conv,X_conv_subset,method = "CAP")
```

```{r}
fit_cap_short$beta

fit_cap_conv$beta
```
Fit of capReg, using CAP-C algorithm
```{r}
fit_cap_C_short<-capReg(Y_c_short,X_short_subset,method="CAP-C")
fit_cap_C_conv<-capReg(Y_c_conv,X_conv_subset,method = "CAP-C")
```

```{r}
fit_cap_C_short$beta

fit_cap_C_conv$beta
```


## Average sample covariance matrix per group of sleepers, per subject

```{r}
source("sample_covariance.R")
sample_cov_short<-sample_covariance(Y_c_short,channel_names,short_ids)
sample_cov_conventional<-sample_covariance(Y_c_conv,channel_names,conventional_ids)
```


## Covariance forcasting

Getting the Inverse of gamma*gamma' 

```{r}
source("gamma_inv.R")
gg_inv_s<-gamma_inv(fit_cap_C_short$gamma)
gg_inv_c<-gamma_inv(fit_cap_C_conv$gamma)
```

Unique X values in short and conventional and Sampling unseen X values for the 2 groups

```{r}
source("sample_unseen.R")
t_for_short<-sample_unseen(X_short_subj$PSQI_AmtSleep,short_ids)
t_for_conv<-sample_unseen(X_conv_subj$PSQI_AmtSleep,conventional_ids)

```

Try for 1st and 2nd subject from short sleepers.
```{r}
source("cov_pred_subj.R")
sig_hat_sj1<-cov_pred_subj(fit_cap_C_short$gamma,fit_cap_C_short$beta,t_for_short$X[1],gg_inv_s)
sig_hat_sj2<-cov_pred_subj(fit_cap_C_short$gamma,fit_cap_C_short$beta,t_for_short$X[2],gg_inv_s)
sig_hat_sj2<-as.matrix(sig_hat_sj2)
```


Extend to all subjects of both groups
Using function built for 1 subject, for short sleepers
```{r}
source("cov_pred_subj.R")
cov_short=list()
cov_short$cov=array(dim=c(length(channel_names),length(channel_names),length(short_ids)))
for(i in 1:length(t_for_short$X)){
  cov_short$sub[i]=t_for_short$sub[i]
  cov_short$cov[,,i]=cov_pred_subj(fit_cap_C_short$gamma,fit_cap_C_short$beta,t_for_short$X[i],gg_inv_s)
}
```


New function
```{r}
source("cov_pred.R")
cov_pred_short = cov_pred(fit_cap_C_short$gamma,fit_cap_C_short$beta,t_for_short,gg_inv_s)
cov_pred_conv = cov_pred(fit_cap_C_conv$gamma,fit_cap_C_conv$beta,t_for_conv,gg_inv_c)
```

## Comparing
Get upper triangles (first, try for 1 matrix)
```{r}
source("get_triangle.R")
t1<-get_triangle(sample_cov_short$cov[,,1])
t1pred<-get_triangle(cov_pred_short$YY[,,1])
#diff1<-t1-t1pred
```

Repeat for all matrices, short sleepers
```{r}
triangle_sample_short=list()
triangle_sample_short$mat=array(dim = c(length(channel_names),length(channel_names),length(short_ids)))
for (i in 1:length(short_ids)){
  triangle_sample_short$mat[,,i]=get_triangle(sample_cov_short$cov[,,i])
}

triangle_pred_short=list()
triangle_pred_short$mat=array(dim = c(length(channel_names),length(channel_names),length(short_ids)))
for (k in 1:length(short_ids)){
  triangle_pred_short$mat[,,k]=get_triangle(cov_pred_short$YY[,,k])
}

diff_short=list()
diff_short$difference=array(dim=c(length(channel_names),length(channel_names),length(short_ids)))
for (m in 1:length(short_ids)){
  diff_short$difference[,,m]=triangle_sample_short$mat[,,m]-triangle_pred_short$mat[,,m]
}
diff_short$difference[,,1]
```

Repeat for all matrices, conventional sleepers
```{r}
triangle_sample_conv=list()
triangle_sample_conv$mat=array(dim = c(length(channel_names),length(channel_names),length(conventional_ids)))
for (i in 1:length(conventional_ids)){
  triangle_sample_conv$mat[,,i]=get_triangle(sample_cov_conventional$cov[,,i])
}

triangle_pred_conv=list()
triangle_pred_conv$mat=array(dim = c(length(channel_names),length(channel_names),length(conventional_ids)))
for (k in 1:length(conventional_ids)){
  triangle_pred_conv$mat[,,k]=get_triangle(cov_pred_conv$YY[,,k])
}

diff_conv=list()
diff_conv$difference=array(dim=c(length(channel_names),length(channel_names),length(conventional_ids)))
for (m in 1:length(conventional_ids)){
  diff_conv$difference[,,m]=triangle_sample_conv$mat[,,m]-triangle_pred_conv$mat[,,m]
}
diff_conv$difference[,,1]
```

Paired t-test, for 1 matrix

```{r}
ttest1<-t.test(x=c(triangle_sample_short$mat[,,1]), y=c(triangle_pred_short$mat[,,1]), paired = TRUE, alternative = "two.sided")
ttest1
```

Paired t-test, all short
```{r}
ttest_short=list()
for (i in 1:length(short_ids)){
  ttesti<-t.test(x=c(triangle_sample_short$mat[,,i]), y=c(triangle_pred_short$mat[,,i]), paired = TRUE, alternative= "two.sided")
  ttest_short[[i]]=ttesti
}
```

Paired t_test, all conv.
```{r}
ttest_conv=list()
for (i in 1:length(conventional_ids)){
  ttesti<-t.test(x=c(triangle_sample_conv$mat[,,i]), y=c(triangle_pred_conv$mat[,,i]), paired = TRUE, alternative= "two.sided")
  ttest_conv[[i]]=ttesti
}
```

Corresponding elements for all short subjects. Specifically: row2, col1
```{r}
tmp_ssample=vector()
for (s in 1:length(short_ids)){
  tmp_ssample[s]=triangle_sample_short$mat[2,1,s]
}

tmp_spred=vector()
for (s in 1:length(short_ids)){
  tmp_spred[s]=triangle_pred_short$mat[2,1,s]
}
```
t_test on those elements
```{r}
ttest_pairwise_short=t.test(x=c(tmp_ssample), y=c(tmp_spred),paired=TRUE, alternative = "two.sided")
```


Now, do the same for all matrix elements

```{r}
source("Repeated_ttest.R")
ttest_short_sleepers<-Repeated_ttest(channel_names,short_ids,triangle_sample_short$mat,triangle_pred_short$mat)
ttest_conv_sleepers<-Repeated_ttest(channel_names,conventional_ids,triangle_sample_conv$mat,triangle_pred_conv$mat)
```

Prepare for BH procedure (multiple testing):

pvalues short and conventional sleepers

```{r}
source("get_pvalues.R")
pvalues_short=get_pvalues(ttest_short_sleepers)
pvalues_conv=get_pvalues(ttest_conv_sleepers)
```

BH procedure
```{r}
library(stats)
BH_short<-p.adjust(pvalues_short, method = "BH")
BH_conv<-p.adjust(pvalues_conv, method = "BH")
```

```{r}
source("back_to_matrix.R")
P_short=back_to_matrix(num_regions,channel_names,BH_short)
P_conv=back_to_matrix(num_regions, channel_names, BH_conv)
```

```{r}
plot_short=image(x=(0:num_regions), y=(0:num_regions),z=P_short, xlab="regions", ylab="regions")
grid(nx=num_regions, ny=num_regions,col="lightgray")
plot_short
```
```{r}
plot_conv=image(x=(0:num_regions), y=(0:num_regions),z=P_conv, xlab="regions", ylab="regions")
grid(nx=num_regions, ny=num_regions,col="lightgray")
plot_conv
```























Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
