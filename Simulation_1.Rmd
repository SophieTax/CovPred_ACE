---
title: "Testing validity"
output: html_notebook
---

Firstly, we're gonna simulate data with no difference among the 2 groups. 
To do this, we sample 4800 data points from a normal distribution, for each subject. 

When sampling from multivariate normal distribution:
  - Mean: 0
  - Covariance: average covariance matrix from control group in original experiment

```{r}
source("sample_unseen.R")
source("sample_covariance.R")
source("gamma_inv.R")
source("cov_pred.R")
source("get_triangle.R")
source("Repeated_ttest.R")
source("get_pvalues.R")


n=10
rejections=vector(length = n)
rejections_BH=vector(length = n)
acceptance=vector(length = n)
for (i in 1:n){
  mu_zeros=replicate(15,0)
  sampled<-mvrnorm(n = 4800, mu=mu_zeros,Sigma=avg_cov_control)
  head(sampled)
  lis <- lapply(1:730, mvrnorm, n=4800, mu=mu_zeros, Sigma=avg_cov_control)
  X_for_short<-sample_unseen(X_short_subj$PSQI_AmtSleep,short_ids)
  X_for_conv<-sample_unseen(X_conv_subj$PSQI_AmtSleep,conventional_ids)
  X_for_short<-cbind(inter = 1, X_for_short)
  X_for_short<-X_for_short[,-3]
  X_for_conv<-cbind(inter = 1, X_for_conv)
  X_for_conv<-X_for_conv[,-3]
  Y_new_short<-lis[1:241]
  Y_new_conventional<-lis[242:730]
  
  fit_short<-capReg(Y_new_short,data.matrix(X_for_short),method="CAP-C")
  fit_conv<-capReg(Y_new_conventional,data.matrix(X_for_conv),method = "CAP-C")
  
  sample_cov_short_new<-sample_covariance(Y_new_short,channel_names,short_ids)
  sample_cov_conventional_new<-sample_covariance(Y_new_conventional,channel_names,conventional_ids)
  
  gg_inv_s_new<-gamma_inv(fit_short$gamma)
  gg_inv_c_new<-gamma_inv(fit_conv$gamma)
  
  t_for_short_new<-sample_unseen(X_for_short$X,short_ids)
  t_for_conv_new<-sample_unseen(X_for_conv$X,conventional_ids)
  
  cov_pred_short_new = cov_pred(fit_short$gamma,fit_short$beta,t_for_short_new,gg_inv_s_new)
  cov_pred_conv_new = cov_pred(fit_conv$gamma,fit_conv$beta,t_for_conv_new,gg_inv_c_new)
  
  ids=append(short_ids,conventional_ids)

  Y_t_new=append(sample_cov_short_new,cov_pred_conv_new)
  names(Y_t_new)<-ids

  Y_c_new=append(cov_pred_short_new,sample_cov_conventional_new)
  names(Y_c_new)<-ids
  
  
  Y_t_triangle_new=list()
  for (j in 1:length(ids)){
    Y_t_triangle_new[[j]]=get_triangle(Y_t_new[[j]], triangle="LOWER")
  }

  Y_c_triangle_new=list()
  for (k in 1:length(ids)){
    Y_c_triangle_new[[k]]=get_triangle(Y_c_new[[k]], triangle="LOWER")
  }

  names(Y_t_triangle_new)<-ids
  names(Y_c_triangle_new)<-ids
  
  paired_ttests_new<-Repeated_ttest(channel_names,ids,triangle="LOWER",Y_t_triangle_new,Y_c_triangle_new)
  
  
  list_pvalues_new=get_pvalues(paired_ttests_new)
  list_pvalues_new=as.double(list_pvalues_new)
  
  pv_indexed_new=tibble(pv=list_pvalues_new, index=seq(1,105))
  pv_ind_ordered_new=pv_indexed_new%>%
  arrange(pv)
  count1=count(filter(pv_ind_ordered_new, pv_ind_ordered_new$pv<0.05))
  
  BH_pvalues_new<-p.adjust(list_pvalues_new, method = "BH")
  
  p_vs_BH_new=tibble(list_pvalues_new,BH_pvalues_new, index=seq(1,105))
#p_vs_BH_new
  p_vs_BH_ord_new=p_vs_BH_new%>%
    arrange(list_pvalues_new)
  
  pvsBH_reduced_new=list(orig_p=numeric(), adj_p=numeric(), ind=numeric())
  j=1
  for (p in 1:length(p_vs_BH_ord_new$list_pvalues_new)){
    if (p_vs_BH_ord_new$list_pvalues_new[p]<p_vs_BH_ord_new$BH_pvalues_new[p]) {
      pvsBH_reduced_new$orig_p[j]=p_vs_BH_ord_new$list_pvalues_new[p]
      pvsBH_reduced_new$adj_p[j]=p_vs_BH_ord_new$BH_pvalues_new[p]
      pvsBH_reduced_new$ind[j]=p_vs_BH_ord_new$index[p]
      j=j+1
    }
  }

#pvsBH_reduced=tibble(original_p,adjusted_p, ind)
  pvsBH_reduced_new=as_tibble(pvsBH_reduced_new)

  acceptance_value_new=as.numeric(max(pvsBH_reduced_new$orig_p))

  acc_index_new=pvsBH_reduced_new$ind[pvsBH_reduced_new$orig_p==acceptance_value_new]
  #pvsBH_reduced
  #acceptance_value_new
  count2=count(filter(p_vs_BH_ord_new, p_vs_BH_ord_new$list_pvalues_new<=acceptance_value_new))
  rejections[i]=count1
  rejections_BH[i]=count2
  acceptance[i]=acceptance_value_new
  i=i+1
}
```



```{r}
mu_zeros=replicate(15,0)
sampled<-mvrnorm(n = 4800, mu=mu_zeros,Sigma=avg_cov_control)
head(sampled)
```

```{r}
lis <- lapply(1:730, mvrnorm, n=4800, mu=mu_zeros, Sigma=avg_cov_control)
```

```{r}
source("sample_unseen.R")
X_for_short<-sample_unseen(X_short_subj$PSQI_AmtSleep,short_ids)
X_for_conv<-sample_unseen(X_conv_subj$PSQI_AmtSleep,conventional_ids)

X_for_short<-cbind(inter = 1, X_for_short)
X_for_short<-X_for_short[,-3]

X_for_conv<-cbind(inter = 1, X_for_conv)
X_for_conv<-X_for_conv[,-3]
```
```{r}
Y_new_short<-lis[1:241]
Y_new_conventional<-lis[242:730]
```


I now have the same number of short and conventional sleepers as in the original experiment
From here, I can repeat the analysis

```{r}
fit_short<-capReg(Y_new_short,data.matrix(X_for_short),method="CAP-C")
fit_conv<-capReg(Y_new_conventional,data.matrix(X_for_conv),method = "CAP-C")
```

```{r}
source("sample_covariance.R")
sample_cov_short_new<-sample_covariance(Y_new_short,channel_names,short_ids)
sample_cov_conventional_new<-sample_covariance(Y_new_conventional,channel_names,conventional_ids)
```


```{r}
source("gamma_inv.R")
gg_inv_s_new<-gamma_inv(fit_short$gamma)
gg_inv_c_new<-gamma_inv(fit_conv$gamma)
```

Unique X values in short and conventional and Sampling unseen X values for the 2 groups

```{r}
source("sample_unseen.R")
t_for_short_new<-sample_unseen(X_for_short$X,short_ids)
t_for_conv_new<-sample_unseen(X_for_conv$X,conventional_ids)

```

```{r}
source("cov_pred.R")
cov_pred_short_new = cov_pred(fit_short$gamma,fit_short$beta,t_for_short_new,gg_inv_s_new)
cov_pred_conv_new = cov_pred(fit_conv$gamma,fit_conv$beta,t_for_conv_new,gg_inv_c_new)
```

```{r}
ids=append(short_ids,conventional_ids)

Y_t_new=append(sample_cov_short_new,cov_pred_conv_new)
names(Y_t_new)<-ids

Y_c_new=append(cov_pred_short_new,sample_cov_conventional_new)
names(Y_c_new)<-ids
```


```{r}
source("get_triangle.R")
Y_t_triangle_new=list()
for (i in 1:length(ids)){
  Y_t_triangle_new[[i]]=get_triangle(Y_t_new[[i]], triangle="LOWER")
}

Y_c_triangle_new=list()
for (k in 1:length(ids)){
  Y_c_triangle_new[[k]]=get_triangle(Y_c_new[[k]], triangle="LOWER")
}

names(Y_t_triangle_new)<-ids
names(Y_c_triangle_new)<-ids
```


```{r}
source("Repeated_ttest.R")
paired_ttests_new<-Repeated_ttest(channel_names,ids,triangle="LOWER",Y_t_triangle_new,Y_c_triangle_new)

```

```{r}
source("get_pvalues.R")
list_pvalues_new=get_pvalues(paired_ttests_new)
list_pvalues_new=as.double(list_pvalues_new)
```


```{r}
source("back_to_matrix.R")
pvalues_matrix_new=back_to_matrix(num_regions, channel_names, list_pvalues_new, triangle="LOWER")
#head(pvalues_matrix)
```

```{r}
pv_indexed_new=tibble(pv=list_pvalues_new, index=seq(1,105))
pv_ind_ordered_new=pv_indexed_new%>%
  arrange(pv)
count(filter(pv_ind_ordered_new, pv_ind_ordered_new$pv<0.05))
```

BH procedure
```{r}
library(stats)
BH_pvalues_new<-p.adjust(list_pvalues_new, method = "BH")
```

```{r}
p_vs_BH_new=tibble(list_pvalues_new,BH_pvalues_new, index=seq(1,105))
#p_vs_BH_new
p_vs_BH_ord_new=p_vs_BH_new%>%
  arrange(list_pvalues_new)
p_vs_BH_ord_new
```

Find highest pvalue that's also lower than the critical level

```{r}
pvsBH_reduced_new=list(orig_p=numeric(), adj_p=numeric(), ind=numeric())
j=1
for (i in 1:length(p_vs_BH_ord_new$list_pvalues_new)){
  if (p_vs_BH_ord_new$list_pvalues_new[i]<p_vs_BH_ord_new$BH_pvalues_new[i]) {
    pvsBH_reduced_new$orig_p[j]=p_vs_BH_ord_new$list_pvalues_new[i]
    pvsBH_reduced_new$adj_p[j]=p_vs_BH_ord_new$BH_pvalues_new[i]
    pvsBH_reduced_new$ind[j]=p_vs_BH_ord_new$index[i]
    j=j+1
  }
}

#pvsBH_reduced=tibble(original_p,adjusted_p, ind)
pvsBH_reduced_new=as_tibble(pvsBH_reduced_new)

acceptance_value_new=as.numeric(max(pvsBH_reduced_new$orig_p))

acc_index_new=pvsBH_reduced_new$ind[pvsBH_reduced_new$orig_p==acceptance_value_new]
pvsBH_reduced
acceptance_value_new
```
```{r}
source("back_to_matrix.R")
BH_matrix_new=back_to_matrix(num_regions, channel_names, BH_pvalues_new,triangle="LOWER")

#colnames(BH_matrix)<-seq(1,15)
#BH_matrix
```

```{r}
BH_matrix_long_new = melt(BH_matrix_new, varnames = c("Rows","Cols"), na.rm = TRUE)
BH_plot_new = ggplot(data = BH_matrix_long_new,aes(Cols, Rows, fill = BH_matrix_long_new$value)) +
    geom_tile(color = "white") +
    scale_fill_stepsn(colours = c("darkblue", "lightblue","lightpink", "cornsilk"), space = "Lab", breaks=c( 0.05,0.2,0.5), 
                        
                         name = "Adjusted Pvalues") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust = 1),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),
          legend.title=element_blank()) +
    coord_fixed() +
  scale_y_reverse()+
    ggtitle("BH adjusted p-values")

pval_mat_long_new = melt(pvalues_matrix_new, varnames = c("Rows","Cols"), na.rm = TRUE)
pval_plot_new = ggplot(data = pval_mat_long_new,aes(Cols, Rows, fill = pval_mat_long_new$value)) +
    geom_tile(color = "white") +
    scale_fill_stepsn(colours = c("darkblue", "lightblue", "lightpink","cornsilk"), space = "Lab", breaks=c( 0.05,0.2,0.5), 
                        
                         name = "Pvalues") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust = 1),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),
          legend.title=element_blank()) +
    coord_fixed() +
  scale_y_reverse()+
    ggtitle("p-values")

pval_plot_new
BH_plot_new
```
```{r}
pval_mat_long_new2 = melt(pvalues_matrix_new, varnames = c("Rows","Cols"), na.rm = TRUE)
pval_mat_long_new2 <- transform(
  pval_mat_long_new2, levels= ifelse(value>0.05, "acc", "rej: <0.05"))
pval_acc_plot_new = ggplot(data = pval_mat_long_new2, aes(Cols, Rows, fill = levels)) +
    geom_tile(color = "white") +
    scale_colour_steps(low ="red", high = "green", space = "Lab",
                        
                         name = "Pvalues") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust = 1),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),
          legend.title=element_blank()) +
    coord_fixed() +
  scale_y_reverse()+
    ggtitle("Pvalues from ttests (acc vs rej)")

pval_mat_long_new3 = melt(pvalues_matrix_new, varnames = c("Rows","Cols"), na.rm = TRUE)
pval_mat_long_new3 <- transform(
  pval_mat_long_new3, levels= ifelse(value>acceptance_value_new, "acc", "rej: <0.7632957"))
pval_acc_plot_new2 = ggplot(data = pval_mat_long_new3, aes(Cols, Rows, fill = levels)) +
    geom_tile(color = "white") +
    scale_colour_steps(low ="red", high = "green", space = "Lab",
                        
                         name = "Pvalues") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust = 1),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),
          legend.title=element_blank()) +
    coord_fixed() +
  scale_y_reverse()+
    ggtitle("Pvalues after BH correction (acc vs rej)")



pval_acc_plot_new

pval_acc_plot_new2
```







