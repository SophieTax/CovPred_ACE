---
title: "Testing validity"
output: html_notebook
---

Firstly, we're gonna simulate data with no difference among the 2 groups. 
To do this, we sample 4800 data points from a normal distribution, for each subject. 

When sampling from multivariate normal distribution:
  - Mean: 0
  - Covariance: average covariance matrix from control group in original experiment

```{r}
mu_zeros=replicate(15,0)
sampled<-mvrnorm(n = 4800, mu=mu_zeros,Sigma=avg_cov_control)
head(sampled)
```

```{r}
lis <- lapply(1:730, mvrnorm, n=4800, mu=mu_zeros, Sigma=avg_cov_control)
```

```{r}
source("sample_unseen.R")
X_for_short<-sample_unseen(X_short_subj$PSQI_AmtSleep,short_ids)
X_for_conv<-sample_unseen(X_conv_subj$PSQI_AmtSleep,conventional_ids)

X_for_short<-cbind(inter = 1, X_for_short)
X_for_short<-X_for_short[,-3]

X_for_conv<-cbind(inter = 1, X_for_conv)
X_for_conv<-X_for_conv[,-3]
```
```{r}
Y_new_short<-lis[1:241]
Y_new_conventional<-lis[242:730]
```


I now have the same number of short and conventional sleepers as in the original experiment
From here, I can repeat the analysis

```{r}
fit_short<-capReg(Y_new_short,data.matrix(X_for_short),method="CAP-C")
fit_conv<-capReg(Y_new_conventional,data.matrix(X_for_conv),method = "CAP-C")
```

```{r}
source("sample_covariance.R")
sample_cov_short_new<-sample_covariance(Y_new_short,channel_names,short_ids)
sample_cov_conventional_new<-sample_covariance(Y_new_conventional,channel_names,conventional_ids)
```


```{r}
source("gamma_inv.R")
gg_inv_s_new<-gamma_inv(fit_short$gamma)
gg_inv_c_new<-gamma_inv(fit_conv$gamma)
```

Unique X values in short and conventional and Sampling unseen X values for the 2 groups

```{r}
source("sample_unseen.R")
t_for_short_new<-sample_unseen(X_for_short$X,short_ids)
t_for_conv_new<-sample_unseen(X_for_conv$X,conventional_ids)

```

```{r}
source("cov_pred.R")
cov_pred_short_new = cov_pred(fit_short$gamma,fit_short$beta,t_for_short_new,gg_inv_s_new)
cov_pred_conv_new = cov_pred(fit_conv$gamma,fit_conv$beta,t_for_conv_new,gg_inv_c_new)
```

```{r}
ids=append(short_ids,conventional_ids)

Y_t_new=append(sample_cov_short_new,cov_pred_conv_new)
names(Y_t_new)<-ids

Y_c_new=append(cov_pred_short_new,sample_cov_conventional_new)
names(Y_c_new)<-ids
```

```{r}
source("get_triangle.R")
triangle_sample_short_new=list()
for (i in 1:length(short_ids)){
  triangle_sample_short_new[[i]]=get_triangle(sample_cov_short_new[[i]])
}

triangle_pred_short_new=list()
for (k in 1:length(short_ids)){
  triangle_pred_short_new[[k]]=get_triangle(cov_pred_short_new[[k]])
}

```

```{r}
triangle_sample_conv_new=list()
for (i in 1:length(conventional_ids)){
  triangle_sample_conv_new[[i]]=get_triangle(sample_cov_conventional_new[[i]])
}

triangle_pred_conv_new=list()
for (k in 1:length(conventional_ids)){
  triangle_pred_conv_new[[k]]=get_triangle(cov_pred_conv_new[[k]])
}

```

```{r}
Y_t_triangle_new=append(triangle_sample_short_new,triangle_pred_conv_new)
Y_c_triangle_new=append(triangle_pred_short_new,triangle_sample_conv_new)
Y_diff_triangle_new=list()
for (m in 1:length(ids)){
  Y_diff_triangle_new[[m]]=Y_t_triangle_new[[m]]-Y_c_triangle_new[[m]]
}
```
```{r}
names(Y_t_triangle_new)<-ids
names(Y_c_triangle_new)<-ids
names(Y_diff_triangle_new)<-ids
```

```{r}
source("Repeated_ttest.R")
paired_ttests_new<-Repeated_ttest(channel_names,ids,Y_t_triangle_new,Y_c_triangle_new)

```

```{r}
source("get_pvalues.R")
list_pvalues_new=get_pvalues(paired_ttests_new)
list_pvalues_new=as.double(list_pvalues_new)
```

BH procedure
```{r}
library(stats)
BH_pvalues_new<-p.adjust(list_pvalues_new, method = "BH")
```

```{r}
p_vs_BH_new=tibble(list_pvalues_new,BH_pvalues_new)
p_vs_BH_new
```

```{r}
pvsBH_reduced_new <- p_vs_BH_new[which(p_vs_BH_new$list_pvalues_new <
                                   p_vs_BH_new$BH_pvalues_new),]
pvsBH_reduced_new
acceptance_value_new=max(pvsBH_reduced_new$list_pvalues_new)
acceptance_value_new
```
```{r}
pv_indexed_new=tibble(pv=list_pvalues_new, index=seq(1,105))
pv_ind_ordered_new=pv_indexed_new%>%
  arrange(pv)
ranked_new=tibble(pv_ind_ordered_new,rank=seq(1,105))
ranked_new
```
```{r}
source("back_to_matrix.R")
BH_matrix_new=back_to_matrix(num_regions,channel_names,BH_pvalues_new)
colnames(BH_matrix_new)<-seq(1,15)
BH_matrix_new
```
```{r}
BH_df_new <- as.data.frame(BH_matrix_new)
BH_df_new$region_row <- seq(1,15)
BH_df_new <- na.omit(melt(BH_df_new, 'region_row', variable.name="region_col"))
BH_df_new$region_col <- factor(BH_df_new$region_col, levels=rev(levels(BH_df_new$region_col)))

```
```{r}
ggplot(BH_df_new, aes(x=region_col, y=region_row)) +
    ggtitle('Adjusted pvalues') +
    theme_bw() +
    xlab('Region') +
    ylab('Region') +
    geom_tile(aes(fill = value), color='white') +
    scale_fill_gradient(low = 'darkblue', high = 'white', space = 'Lab') +
    theme(axis.text.x=element_text(angle=90),
          axis.ticks=element_blank(),
          axis.line=element_blank(),
          panel.border=element_blank(),
          panel.grid.major=element_line(color='#eeeeee'))

```
```{r}
plot_cov = function(mat){
  #rownames(mat)=colnames(mat)=channel_names
  #mat_long=melt(mat, na.rm = TRUE)
  ggplot(data=mat, aes(region_col, region_row,fill=value))+
    geom_tile(color="white")+
    scale_fill_gradient2(low="darkblue", high="red", mid="white",
                         midpoint = 0.1,space="Lab",
                         name="Adjusted p-values")+
    theme_minimal()+
    theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust = 1),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),
          legend.position="right") +
    coord_fixed()
}

plot_cov(BH_df_new)
```






